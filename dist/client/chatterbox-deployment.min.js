/*! chatterbox-deployment 02-07-2015 */
if(!/(&|\?)username=/.test(window.location.search)){var newSearch=window.location.search;""!==newSearch&"?"!==newSearch&&(newSearch+="&"),newSearch+="username="+(prompt("What is your name?")||"anonymous"),window.location.search=newSearch}$.ajaxPrefilter(function(a,b,c){c.setRequestHeader("X-Parse-Application-Id","voLazbq9nXuZuos9hsmprUz7JwM2N0asnPnUcI7r"),c.setRequestHeader("X-Parse-REST-API-Key","QC2F43aSAghM97XidJw8Qiy1NXlpL5LR45rhAVAf")});var app;$(function(){app={server:"https://api.parse.com/1/classes/chatterbox/",username:"anonymous",roomname:"lobby",lastMessageId:0,friends:{},init:function(){app.username=window.location.search.substr(10),app.$main=$("#main"),app.$message=$("#message"),app.$chats=$("#chats"),app.$roomSelect=$("#roomSelect"),app.$send=$("#send"),app.$main.on("click",".username",app.addFriend),app.$send.on("submit",app.handleSubmit),app.$roomSelect.on("change",app.saveRoom),app.startSpinner(),app.fetch(!1),setInterval(app.fetch,3e3)},send:function(a){app.startSpinner(),app.$message.val(""),$.ajax({url:app.server,type:"POST",data:JSON.stringify(a),contentType:"application/json",success:function(a){console.log("chatterbox: Message sent"),app.fetch()},error:function(a){console.error("chatterbox: Failed to send message")}})},fetch:function(a){$.ajax({url:app.server,type:"GET",contentType:"application/json",data:{order:"-createdAt"},success:function(b){if(console.log("chatterbox: Messages fetched"),b.results&&b.results.length){var c=b.results[b.results.length-1],d=$(".chat span").first().data("roomname");app.stopSpinner(),(c.objectId!==app.lastMessageId||app.roomname!==d)&&(app.populateRooms(b.results),app.populateMessages(b.results,a),app.lastMessageId=c.objectId)}},error:function(a){console.error("chatterbox: Failed to fetch messages")}})},clearMessages:function(){app.$chats.html("")},populateMessages:function(a,b){app.clearMessages(),app.stopSpinner(),Array.isArray(a)&&a.forEach(app.addMessage);var c=app.$chats.prop("scrollHeight");b?app.$chats.animate({scrollTop:c}):app.$chats.scrollTop(c)},populateRooms:function(a){if(app.$roomSelect.html('<option value="__newRoom">New room...</option><option value="" selected>Lobby</option></select>'),a){var b={};a.forEach(function(a){var c=a.roomname;c&&!b[c]&&(app.addRoom(c),b[c]=!0)})}app.$roomSelect.val(app.roomname)},addRoom:function(a){var b=$("<option/>").val(a).text(a);app.$roomSelect.append(b)},addMessage:function(a){if(a.roomname||(a.roomname="lobby"),a.roomname===app.roomname){var b=$('<div class="chat"/>'),c=$('<span class="username"/>');c.text(a.username+": ").attr("data-username",a.username).attr("data-roomname",a.roomname).appendTo(b),app.friends[a.username]===!0&&c.addClass("friend");var d=$("<br><span/>");d.text(a.text).appendTo(b),app.$chats.append(b)}},addFriend:function(a){var b=$(a.currentTarget).attr("data-username");if(void 0!==b){console.log("chatterbox: Adding %s as a friend",b),app.friends[b]=!0;var c='[data-username="'+b.replace(/"/g,'\\"')+'"]';$(c).addClass("friend")}},saveRoom:function(a){var b=app.$roomSelect.prop("selectedIndex");if(0===b){var c=prompt("Enter room name");c&&(app.roomname=c,app.addRoom(c),app.$roomSelect.val(c),app.fetch())}else app.startSpinner(),app.roomname=app.$roomSelect.val(),app.fetch()},handleSubmit:function(a){var b={username:app.username,text:app.$message.val(),roomname:app.roomname||"lobby"};app.send(b),a.preventDefault()},startSpinner:function(){$(".spinner img").show(),$("form input[type=submit]").attr("disabled","true")},stopSpinner:function(){$(".spinner img").fadeOut("fast"),$("form input[type=submit]").attr("disabled",null)}}}());